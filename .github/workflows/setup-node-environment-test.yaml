on:
  pull_request:
    paths:
      - "setup-node-environment/**"
      - ".github/workflows/setup-node-environment-test.yaml"
  push:
    paths:
      - "setup-node-environment/**"
      - ".github/workflows/setup-node-environment-test.yaml"
env:
  TZ: Asia/Shanghai
  package_json_content: |
    {
      "packageManager": "pnpm@10.6.5",
      "dependencies": {
        "bun": "^1.2.5"
      }
    }

concurrency:
  group: ${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  generate_lock:
    runs-on: ubuntu-latest
    outputs:
      lock_file_content: ${{ steps.generate_lock.outputs.lock_file_content }}
    steps:
      - uses: pnpm/action-setup@v4
        with:
          version: latest
          standalone: true
      - id: generate_lock
        env:
          CI: 'false'
        run: |
          set -x;
          cat <<EOF > package.json
          ${{ env.package_json_content }}
          EOF
          pnpm config list
          cat package.json
          pnpm install --lockfile-only
          echo "lock_file_content<<EOF" >> $GITHUB_OUTPUT
          cat pnpm-lock.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  tests:
    needs: generate_lock
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "é»˜è®¤é…ç½®ï¼ˆLTS Node + lock æ–‡ä»¶ï¼‰"
            npmrc_content: ''
            pnpm_workspace_content: ''
            lock_file: 'true'
            cwd: ''
          
          - name: "é»˜è®¤é…ç½® + å­ç›®å½•"
            npmrc_content: ''
            pnpm_workspace_content: ''
            lock_file: 'true'
            cwd: 'test'
          
          - name: "ä½¿ç”¨ .npmrc æŒ‡å®š Node 22"
            npmrc_content: |
              use-node-version=22.14.0 # https://pnpm.io/zh/npmrc#use-node-version
            pnpm_workspace_content: ''
            lock_file: 'true'
            cwd: ''
          
          - name: "ä½¿ç”¨ pnpm-workspace.yaml æŒ‡å®š Node 24"
            npmrc_content: ''
            pnpm_workspace_content: |
              useNodeVersion: 24.11.0 # https://pnpm.io/zh/settings#usenodeversion
            lock_file: 'true'
            cwd: ''
          
          - name: "æ—  lock æ–‡ä»¶åœºæ™¯"
            npmrc_content: ''
            pnpm_workspace_content: ''
            lock_file: 'false'
            cwd: ''
          
          - name: "æ—  lock æ–‡ä»¶ + å­ç›®å½•"
            npmrc_content: ''
            pnpm_workspace_content: ''
            lock_file: 'false'
            cwd: 'test'
    steps:
      # - uses: actions/checkout@main
      - name: æ‰“å°æµ‹è¯•åœºæ™¯
        run: |
          echo "ğŸ¤–---- æµ‹è¯•åœºæ™¯: ${{ matrix.name }} ----ğŸ¤–"
          echo "npmrc_content: ${{ matrix.npmrc_content }}"
          echo "pnpm_workspace_content: ${{ matrix.pnpm_workspace_content }}"
          echo "lock_file: ${{ matrix.lock_file }}"
          echo "cwd: ${{ matrix.cwd }}"
          echo "GITHUB_WORKSPACE: ${{ github.workspace }}"

      - name: Create test directory
        if: matrix.cwd != ''
        run: |
          mkdir -p ${{ matrix.cwd }}
          set -x;
          ls -l -R .
          pwd

      - name: Create .npmrc
        working-directory: ${{ matrix.cwd }}
        if: matrix.npmrc_content != ''
        run: |
          cat <<EOF > .npmrc
          ${{ matrix.npmrc_content }}
          EOF
          set -x;
          ls -l -R .
          pwd
          cat .npmrc

      - name: Create pnpm-workspace.yaml
        working-directory: ${{ matrix.cwd }}
        if: matrix.pnpm_workspace_content != ''
        run: |
          cat <<EOF > pnpm-workspace.yaml
          ${{ matrix.pnpm_workspace_content }}
          EOF
          set -x;
          ls -l -R .
          pwd
          cat pnpm-workspace.yaml

      - name: Create package.json
        working-directory: ${{ matrix.cwd }}
        run: |
          mkdir -p ${{ github.workspace }}/.git
          cat <<EOF > package.json
          ${{ env.package_json_content }}
          EOF
          set -x;
          ls -l -R .
          pwd
          cat package.json

      - name: Create pnpm-lock.yaml
        working-directory: ${{ matrix.cwd }}
        if: matrix.lock_file == 'true'
        run: |
          cat <<EOF > pnpm-lock.yaml
          ${{ needs.generate_lock.outputs.lock_file_content }}
          EOF
          set -x;
          ls -l -R .
          pwd
          cat pnpm-lock.yaml

      - name: âš™ï¸ è®¾ç½® Node ç¯å¢ƒ
        uses: yanhao98/composite-actions/setup-node-environment@main
        with:
          working-directory: ${{ matrix.cwd }}

      - name: âœ… éªŒè¯å®‰è£…ç»“æœ
        working-directory: ${{ matrix.cwd }}
        run: |
          echo "ğŸ¤–---- éªŒè¯ Node å’Œ PNPM å®‰è£… ----ğŸ¤–"
          echo "Node ç‰ˆæœ¬: $(node --version)"
          echo "PNPM ç‰ˆæœ¬: $(pnpm --version)"
          echo "PNPM å­˜å‚¨è·¯å¾„: $(pnpm store path)"
          
          # éªŒè¯ä¾èµ–æ˜¯å¦å®‰è£…
          if [ -d node_modules ]; then
            echo "âœ… node_modules å·²åˆ›å»º"
            ls -la node_modules/ | head -n 10
          else
            echo "âŒ node_modules æœªæ‰¾åˆ°"
            # exit 1
          fi
          
          # éªŒè¯ Node ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆé¢„æœŸ
          node_version=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
          echo "å½“å‰ Node ä¸»ç‰ˆæœ¬: $node_version"
          
          # æ ¹æ®é…ç½®éªŒè¯ç‰ˆæœ¬
          if [ -n "${{ matrix.pnpm_workspace_content }}" ]; then
            echo "é¢„æœŸä½¿ç”¨ pnpm-workspace.yaml ä¸­çš„ç‰ˆæœ¬ (24)"
            if [ "$node_version" != "24" ]; then
              echo "âŒ Node ç‰ˆæœ¬ä¸ç¬¦åˆé¢„æœŸï¼Œåº”ä¸º 24ï¼Œå®é™…ä¸º $node_version"
              # exit 1
            fi
          elif [ -n "${{ matrix.npmrc_content }}" ]; then
            echo "é¢„æœŸä½¿ç”¨ .npmrc ä¸­çš„ç‰ˆæœ¬ (22)"
            if [ "$node_version" != "22" ]; then
              echo "âŒ Node ç‰ˆæœ¬ä¸ç¬¦åˆé¢„æœŸï¼Œåº”ä¸º 22ï¼Œå®é™…ä¸º $node_version"
              # exit 1
            fi
          else
            echo "é¢„æœŸä½¿ç”¨é»˜è®¤ LTS ç‰ˆæœ¬"
            # LTS ç‰ˆæœ¬é€šå¸¸æ˜¯ 20, 22 ç­‰å¶æ•°ç‰ˆæœ¬
            if [ $((node_version % 2)) -ne 0 ]; then
              echo "âš ï¸  è­¦å‘Š: Node ç‰ˆæœ¬ $node_version å¯èƒ½ä¸æ˜¯ LTS ç‰ˆæœ¬"
            fi
          fi
          echo "âœ… Node ç‰ˆæœ¬éªŒè¯é€šè¿‡"
