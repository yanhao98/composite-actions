# ğŸ”— é“¾æ¥:
# æºæ–‡ä»¶: https://github.com/obytes/react-native-template-obytes/blob/master/.github/actions/setup-node-pnpm-install/action.yml
# å¤åˆæ“ä½œæ–‡æ¡£: https://docs.github.com/en/actions/creating-actions/creating-a-composite-action

# âœï¸ æè¿°:
# è¿™æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼Œæ„å‘³ç€å®ƒå¯ä»¥åœ¨å…¶ä»–æ“ä½œä¸­ä½¿ç”¨ã€‚
# å®ƒå‡ ä¹ç”¨äºæ‰€æœ‰å·¥ä½œæµä¸­ï¼Œä»¥è®¾ç½®ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–é¡¹ã€‚
# åœ¨æ­¤å¤„æ›´æ–°åŒ…ç®¡ç†å™¨æˆ– Node ç‰ˆæœ¬å°†åæ˜ åœ¨æ‰€æœ‰å·¥ä½œæµä¸­ã€‚

# ğŸ‘€ ä½¿ç”¨ç¤ºä¾‹:
#       - name : ğŸ“¦ è®¾ç½® Node + PNPM + å®‰è£…ä¾èµ–
#         uses: ./.github/actions/setup-node-pnpm-install

name: 'è®¾ç½® Node ç¯å¢ƒ'
description: 'è®¾ç½® pnpm + Node.js + å®‰è£…ä¾èµ–é¡¹'
inputs:
  pnpm_standalone: # æ˜¯å¦å°† pnpm ç”¨ä½œç‹¬ç«‹åŒ… https://github.com/pnpm/action-setup?tab=readme-ov-file#standalone
    description: 'æ˜¯å¦å°† pnpm ç”¨ä½œç‹¬ç«‹åŒ…'
    required: false
    default: 'false'
  # https://github.com/pnpm/action-setup/blob/d648c2dd069001a242c621c8306af467f150e99d/action.yml#L18C3-L18C20
  working-directory:
    description: 'å·¥ä½œç›®å½•'
    required: false
    default: '.'
runs:
  using: 'composite'
  steps:
    - id: check-git-folder
      shell: bash
      run: |
        # ğŸ¤–----åˆ¤æ–­æ˜¯å¦å­˜åœ¨ .git æ–‡ä»¶å¤¹----ğŸ¤– #
        [ -d ${{ github.workspace }}/.git ] && { echo "ğŸ¤– æ‰¾åˆ° .git æ–‡ä»¶å¤¹"; echo "git-folder-exists=true" >> $GITHUB_OUTPUT; } || { echo "ğŸ¤– æœªæ‰¾åˆ° .git æ–‡ä»¶å¤¹"; echo "git-folder-exists=false" >> $GITHUB_OUTPUT; }

    - uses: actions/checkout@v4.2.2
      if: steps.check-git-folder.outputs.git-folder-exists == 'false'
      with:
        # fetch-depth: 0 # 0 ä»£è¡¨å®Œæ•´æ£€å‡ºï¼Œsemantic-release éœ€è¦
        filter: blob:none # æˆ‘ä»¬ä¸éœ€è¦æ‰€æœ‰ blobï¼Œåªéœ€è¦å®Œæ•´çš„æ ‘
        show-progress: false

    - id: prepare
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        # ğŸ¤–---- å‡†å¤‡ç¯å¢ƒå˜é‡ ----ğŸ¤– #

        # --- 1. åŒ…ç®¡ç†å™¨ ---
        echo "::group::ğŸ“¦ è·å–åŒ…ç®¡ç†å™¨ä¿¡æ¯"
        pkg_manager=$(node -p "try { require('./package.json').packageManager } catch(e) { '' }")
        echo "ä» package.json è·å–çš„åŒ…ç®¡ç†å™¨: $pkg_manager"
        echo "::endgroup::"

        # --- 2. ç¡®å®š PNPM ç‰ˆæœ¬ ---
        echo "::group::ğŸ”§ ç¡®å®š PNPM ç‰ˆæœ¬"
        pnpm_version=""
        # å¦‚æœ packageManager ä¸ºç©ºã€undefined æˆ– nullï¼Œåˆ™ä½¿ç”¨æœ€æ–°çš„ pnpm
        if [ -z "$pkg_manager" ] || [ "$pkg_manager" == "undefined" ] || [ "$pkg_manager" == "null" ]; then
          pnpm_version="latest"
          echo "æœªæŒ‡å®šæˆ–æ— æ•ˆçš„ packageManagerï¼Œä½¿ç”¨ pnpm ç‰ˆæœ¬: latest"
        else
          # å¦‚æœæŒ‡å®šäº† pnpm ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ "pnpm@8.6.0"ï¼‰ï¼Œåˆ™æå–ç‰ˆæœ¬å·
          if [[ "$pkg_manager" == pnpm* ]]; then
              pnpm_version=$(echo "$pkg_manager" | cut -d '@' -f 2)
              echo "ä½¿ç”¨ package.json ä¸­çš„ pnpm ç‰ˆæœ¬: $pnpm_version"
          else
              echo "æŒ‡å®šäº†é pnpm åŒ…ç®¡ç†å™¨: $pkg_managerã€‚å°†ç”± pnpm/action-setup å¤„ç†ç‰ˆæœ¬ã€‚"
              # è®© pnpm/action-setup æ ¹æ® corepack æˆ–å…¶é»˜è®¤è®¾ç½®å†³å®šç‰ˆæœ¬
              pnpm_version="" # å¦‚æœä¸æ˜¯ pnpm æˆ–æœªæ­£ç¡®æŒ‡å®šï¼Œåˆ™æ˜¾å¼è®¾ç½®ä¸ºç©º
          fi
        fi
        echo "::endgroup::"

        # --- 3. æ£€æŸ¥ PNPM å®‰è£…æƒ…å†µ ---
        echo "::group::ğŸ” æ£€æŸ¥ PNPM å®‰è£…æƒ…å†µ"
        is_pnpm_installed="false"
        pnpm_executable_path=""
        installed_pnpm_version="æ— æ³•è·å–" # ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥æ—¶çš„é»˜è®¤å€¼

        # ä½¿ç”¨ command -v æ£€æŸ¥ pnpm æ˜¯å¦åœ¨ PATH ä¸­å¹¶ä¸”å¯æ‰§è¡Œ
        if command -v pnpm >/dev/null 2>&1; then
            pnpm_executable_path=$(command -v pnpm)
            echo "æ‰¾åˆ° PNPM å¯æ‰§è¡Œæ–‡ä»¶äº: $pnpm_executable_path"
            # å°è¯•è·å–ç‰ˆæœ¬å·ï¼Œä½†ä¸å› å¤±è´¥è€Œé€€å‡º
            if pnpm_version_output=$(pnpm --version 2>/dev/null); then
                installed_pnpm_version="$pnpm_version_output"
                is_pnpm_installed="true" # ç¡®è®¤ pnpm å¯æ‰§è¡Œä¸”èƒ½è·å–ç‰ˆæœ¬
                echo "å·²å®‰è£…çš„ PNPM ç‰ˆæœ¬: $installed_pnpm_version"
            else
                # pnpm å‘½ä»¤å­˜åœ¨ä½†è·å–ç‰ˆæœ¬å¤±è´¥ï¼Œå¯èƒ½å®‰è£…ä¸å®Œæ•´æˆ–æœ‰é—®é¢˜
                is_pnpm_installed="true" # æ ‡è®°ä¸ºå·²å®‰è£…ï¼Œå› ä¸ºå‘½ä»¤å­˜åœ¨
                echo "è­¦å‘Šï¼šPNPM å‘½ä»¤å­˜åœ¨ï¼Œä½†æ— æ³•è·å–ç‰ˆæœ¬å·ã€‚å¯èƒ½å®‰è£…ä¸å®Œæ•´æˆ–å­˜åœ¨é—®é¢˜ã€‚"
                echo "å°†ç»§ç»­æ‰§è¡Œï¼Œåç»­æ­¥éª¤å¯èƒ½ä¼šé‡æ–°å®‰è£…æˆ–ä¿®å¤ã€‚"
            fi
        else
            echo "PNPM æœªåœ¨ PATH ä¸­æ‰¾åˆ°æˆ–ä¸å¯æ‰§è¡Œã€‚"
            is_pnpm_installed="false"
        fi
        echo "::endgroup::"

        # --- 4. æ£€æŸ¥ PNPM Lock æ–‡ä»¶ ---
        echo "::group::ğŸ“„ æ£€æŸ¥ PNPM Lock æ–‡ä»¶"
        has_pnpm_lock="false"
        if [ -f pnpm-lock.yaml ]; then
            has_pnpm_lock="true"
            echo "æ‰¾åˆ° pnpm-lock.yamlã€‚"
        else
            echo "æœªæ‰¾åˆ° pnpm-lock.yamlã€‚"
        fi
        echo "::endgroup::"

        # --- 5. ç¡®å®š Node.js ç‰ˆæœ¬å¹¶æ¸…ç† .npmrc ---
        echo "::group::âš™ï¸ ç¡®å®š Node.js ç‰ˆæœ¬å¹¶æ¸…ç† .npmrc"
        node_version="lts/*" # é»˜è®¤ Node ç‰ˆæœ¬
        if [ ! -f .npmrc ]; then
            echo "æœªæ‰¾åˆ° .npmrcï¼Œåˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ã€‚"
            touch .npmrc
        else
            echo "æ‰¾åˆ° .npmrc æ–‡ä»¶ã€‚"
        fi

        # ä» .npmrc è¯»å– use-node-version
        node_version_in_npmrc=$(sed -n 's/.*use-node-version=\([0-9.]*\).*/\1/p' .npmrc)
        if [ -n "$node_version_in_npmrc" ]; then
            node_major_version_in_npmrc=$(echo "$node_version_in_npmrc" | cut -d. -f1)
            if [ -n "$node_major_version_in_npmrc" ]; then
                node_version="$node_major_version_in_npmrc"
                echo ".npmrc ä¸­æŒ‡å®šçš„ Node ç‰ˆæœ¬: $node_version_in_npmrc -> ä½¿ç”¨ä¸»ç‰ˆæœ¬: $node_version"
            else
                echo "æ— æ³•ä» .npmrc ($node_version_in_npmrc) æå–ä¸» Node ç‰ˆæœ¬ã€‚ä½¿ç”¨é»˜è®¤å€¼: $node_version"
            fi
        else
            echo ".npmrc ä¸­æœªæ‰¾åˆ° 'use-node-version'ã€‚ä½¿ç”¨é»˜è®¤å€¼: $node_version"
        fi

        # æ¸…ç† .npmrcï¼šåˆ é™¤ use-node-version å’Œ node-mirror è¡Œ
        echo "æ­£åœ¨æ¸…ç† .npmrc..."
        # ä½¿ç”¨ -i.bak ä»¥å…¼å®¹ä¸åŒ sed ç‰ˆæœ¬ï¼Œå¹¶åœ¨åˆ›å»ºå¤‡ä»½ååˆ é™¤
        sed -i.bak -e '/use-node-version/d' -e '/node-mirror/d' .npmrc
        [ -f .npmrc.bak ] && rm .npmrc.bak
        echo ".npmrc å·²æ¸…ç†ã€‚"
        echo "::endgroup::"

        # --- 6. è®¾ç½®è¾“å‡º ---
        echo "::group::ğŸš€ è®¾ç½® GitHub Actions è¾“å‡º"
        echo "packageManager=${pkg_manager}" >> $GITHUB_OUTPUT
        echo "pnpmVersion=${pnpm_version}" >> $GITHUB_OUTPUT
        echo "pnpmInstalled=${is_pnpm_installed}" >> $GITHUB_OUTPUT
        echo "pnpmLockExists=${has_pnpm_lock}" >> $GITHUB_OUTPUT
        echo "nodeVersion=${node_version}" >> $GITHUB_OUTPUT
        echo "è¾“å‡ºå·²è®¾ç½®:"
        printf "  %-16s %s\n" "packageManager:" "${pkg_manager}"
        printf "  %-16s %s\n" "pnpmVersion:" "${pnpm_version}"
        printf "  %-16s %s\n" "pnpmInstalled:" "${is_pnpm_installed}"
        printf "  %-16s %s\n" "pnpmLockExists:" "${has_pnpm_lock}"
        printf "  %-16s %s\n" "nodeVersion:" "${node_version}"
        echo "::endgroup::"

    - uses: pnpm/action-setup@v4 # https://github.com/pnpm/action-setup?tab=readme-ov-file#inputs
      if: steps.prepare.outputs.pnpmInstalled == 'false'
      with:
        version: ${{ steps.prepare.outputs.pnpmVersion }}
        standalone: ${{ inputs.pnpm_standalone }}

    - uses: actions/setup-node@v4 # https://github.com/actions/setup-node?tab=readme-ov-file#usage
      with:
        node-version: ${{ steps.prepare.outputs.nodeVersion }}
        cache: ''

    - id: pnpm-store-dir
      shell: bash
      run: |
        echo "ğŸ¤–---- è·å– PNPM å­˜å‚¨ç›®å½• ----ğŸ¤–"
        echo "PNPM å­˜å‚¨ç›®å½•: $(pnpm store path)"
        echo "pnpmStoreDir=$(pnpm store path)" >> $GITHUB_OUTPUT

    - id: cache-pnpm-restore
      uses: actions/cache/restore@v4 # https://github.com/actions/cache/blob/main/restore/action.yml
      with:
        path: ${{ steps.pnpm-store-dir.outputs.pnpmStoreDir }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - run: echo "package-import-method=hardlink" >> .npmrc
      shell: bash

    - if: steps.cache-pnpm-restore.outputs.cache-hit == 'true'
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      run: |
        echo "ğŸ¤–---- ç¼“å­˜å‘½ä¸­ï¼Œå®‰è£…ä¾èµ– ----ğŸ¤–"
        pnpm install --prefer-offline
        #  --frozen-lockfile
        # ERR_PNPM_NO_LOCKFILEâ€‰ Cannot install with "frozen-lockfile" because pnpm-lock.yaml is absent

    - if: steps.cache-pnpm-restore.outputs.cache-hit != 'true'
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      run: |
        echo "ğŸ¤–---- ç¼“å­˜æœªå‘½ä¸­ï¼Œå®‰è£…ä¾èµ– ----ğŸ¤–"
        set -x;
        pnpm fetch # https://pnpm.io/zh/cli/fetch
        pnpm install --prefer-offline
        #  --frozen-lockfile
        # ERR_PNPM_NO_LOCKFILEâ€‰ Cannot install with "frozen-lockfile" because pnpm-lock.yaml is absent
        pnpm store prune
        echo "cache-hit: ${{ steps.cache-pnpm-restore.outputs.cache-hit }}"

    - id: cache-pnpm-save
      if: always() && steps.cache-pnpm-restore.outputs.cache-hit == 'false'
      uses: actions/cache/save@v4
      with:
        path: ${{ steps.pnpm-store-dir.outputs.pnpmStoreDir }}
        key: ${{ steps.cache-pnpm-restore.outputs.cache-primary-key }}
# # https://github.com/pnpm/pnpm/issues/7192#issuecomment-2353298966
# package-import-method=hardlink

# rm -r node_modules
# pnpm fetch
# pnpm install --offline
# pnpm store prune
# #
# rm -r node_modules
# pnpm install --offline
